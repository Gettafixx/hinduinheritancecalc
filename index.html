<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hindu Succession Act, 1956 Inheritance Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Harmony -->
    <!-- Application Structure Plan: A multi-step wizard to guide users through the complex legal process. This sequential flow prevents user overwhelm and ensures data is collected in a logical order that mirrors the legal decision tree. Steps: 1. Welcome & Applicability (Gateway), 2. Deceased's Details, 3. Property Portfolio (allowing multiple entries), 4. Family Tree Builder (dynamic form), 5. Special Circumstances, 6. Interactive Results Dashboard. This task-oriented structure is more user-friendly than a single large form and allows for context-sensitive help, enhancing usability and trust. -->
    <!-- Visualization & Content Choices: The primary visualization is a dynamic donut chart (Chart.js) on the results page to show the percentage distribution of the estate. Goal: Compare proportions. Interaction: Hovering over a chart segment will display the heir's name, share, and value. This is paired with a detailed HTML table for precise figures and a 'Show Calculation' text block (JS toggle) to provide transparent, step-by-step reasoning for each heir's share, directly addressing the need for clarity and trust. The family tree is built using a structured HTML form, avoiding complex graphics. Goal: Organize information. Interaction: The form dynamically adds fields for predeceased children's heirs, guiding the user. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active { background-color: #4f46e5; color: white; }
        .step-indicator.completed { background-color: #16a34a; color: white; }
        .form-section { border-left: 2px solid #e5e7eb; padding-left: 1.5rem; margin-top: 1.5rem; }
        .help-tooltip { position: relative; display: inline-block; cursor: pointer; }
        .help-tooltip .tooltiptext { visibility: hidden; width: 240px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -120px; opacity: 0; transition: opacity 0.3s; font-weight: normal; font-size: 0.875rem; }
        .help-tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .chart-container { position: relative; width: 100%; max-width: 450px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        .radio-btn-group button.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .radio-btn-group button { background-color: #f3f4f6; color: #374151; border-color: #d1d5db; }
        .required-label::after { content: ' *'; color: #ef4444; }
        .property-card { transition: all 0.3s ease; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn:not(.active) { background-color: #e5e7eb; color: #4b5563; }
        .flowchart-box { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .flowchart-arrow { text-align: center; font-size: 1.5rem; color: #9ca3af; margin: 0.5rem 0; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">Hindu Inheritance Calculator</h1>
            <p class="text-slate-600 mt-2">A comprehensive tool for understanding property distribution.</p>
        </header>

        <!-- Tab Controls -->
        <div class="mb-6 flex justify-center p-1 bg-slate-200 rounded-xl">
            <button id="tab-legal" class="tab-btn active w-1/3 py-2 px-4 rounded-lg font-semibold">Legal Calculator</button>
            <button id="tab-percentage" class="tab-btn w-1/3 py-2 px-4 rounded-lg font-semibold">Percentage Tool</button>
            <button id="tab-law" class="tab-btn w-1/3 py-2 px-4 rounded-lg font-semibold">The Law Explained</button>
        </div>

        <!-- Legal Calculator Content -->
        <div id="legal-calculator-content">
            <main id="calculator-body" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <!-- Step Indicator -->
                <div id="step-indicator-container" class="flex items-center justify-center space-x-2 md:space-x-4 mb-8 text-xs md:text-sm">
                    <div id="step-1-indicator" class="step-indicator active flex items-center justify-center w-8 h-8 rounded-full bg-slate-200">1</div>
                    <div class="flex-1 h-1 bg-slate-200 rounded-full"></div>
                    <div id="step-2-indicator" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-slate-200">2</div>
                    <div class="flex-1 h-1 bg-slate-200 rounded-full"></div>
                    <div id="step-3-indicator" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-slate-200">3</div>
                    <div class="flex-1 h-1 bg-slate-200 rounded-full"></div>
                    <div id="step-4-indicator" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-slate-200">4</div>
                    <div class="flex-1 h-1 bg-slate-200 rounded-full"></div>
                    <div id="step-5-indicator" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full bg-slate-200">5</div>
                </div>
            
                <!-- Screen 1: Applicability -->
                <div id="screen-1">
                    <h2 class="text-2xl font-semibold mb-2">Let's Get Started</h2>
                    <p class="text-slate-600 mb-6">First, let's confirm if this calculator applies to your situation. The Hindu Succession Act, 1956 has specific applicability.</p>
                    <div class="space-y-4">
                        <label class="font-semibold text-slate-700 block required-label">What was the religion of the person who passed away?
                            <span class="help-tooltip text-indigo-500 font-normal"> [?]
                                <span class="tooltiptext">The Hindu Succession Act, 1956 governs inheritance only for Hindus, Buddhists, Jains, and Sikhs.</span>
                            </span>
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Options will be dynamically inserted here by JS -->
                        </div>
                    </div>
                     <div id="applicability-error" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg">
                        This calculator is designed for inheritance under the Hindu Succession Act, 1956, which does not apply to the selected religion. Please consult a legal expert for advice.
                    </div>
                </div>

                <!-- Screen 2: Deceased's Details -->
                <div id="screen-2" class="hidden">
                     <h2 class="text-2xl font-semibold mb-2">About the Person Who Passed Away</h2>
                     <p class="text-slate-600 mb-6">These details determine which set of legal rules to apply.</p>
                    <div class="space-y-6">
                        <div>
                            <label class="font-semibold text-slate-700 block mb-2 required-label">Gender of the deceased
                                 <span class="help-tooltip text-indigo-500 font-normal"> [?]
                                    <span class="tooltiptext">Gender determines which set of succession rules (Section 8 for males, Section 15 for females) to apply.</span>
                                </span>
                            </label>
                            <div id="gender-group" class="radio-btn-group flex space-x-4">
                                <button data-value="male" class="flex-1 p-3 text-center border rounded-lg hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Male</button>
                                <button data-value="female" class="flex-1 p-3 text-center border rounded-lg hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Female</button>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-slate-700 block mb-2 required-label">When did the person pass away?
                                 <span class="help-tooltip text-indigo-500 font-normal"> [?]
                                    <span class="tooltiptext">This is a critical legal date. The 2005 amendment to the Hindu Succession Act gave daughters equal rights in ancestral property. Your answer here is essential for an accurate calculation.</span>
                                </span>
                            </label>
                             <div id="dod-group" class="radio-btn-group flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                                <button data-value="true" class="flex-1 p-3 text-center border rounded-lg hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">On or After Sep 9, 2005</button>
                                <button data-value="false" class="flex-1 p-3 text-center border rounded-lg hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">Before Sep 9, 2005</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen 3: Property Portfolio -->
                <div id="screen-3" class="hidden">
                     <h2 class="text-2xl font-semibold mb-2">Estate Properties</h2>
                     <p class="text-slate-600 mb-6">List each major asset of the deceased. The law treats properties differently based on how they were acquired.</p>
                     <div id="property-list" class="space-y-6">
                        <!-- Property cards will be added here -->
                     </div>
                     <button id="add-property-btn" class="mt-6 w-full p-3 bg-indigo-100 text-indigo-700 font-semibold rounded-lg hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        + Add Another Property
                    </button>
                </div>

                <!-- Screen 4: Family Tree -->
                <div id="screen-4" class="hidden">
                    <h2 class="text-2xl font-semibold mb-2">Family Tree</h2>
                    <p class="text-slate-600 mb-6">Please provide details about the deceased's family. The law has a strict order of heirs.</p>
                    <div id="family-tree-form" class="space-y-6">
                       <!-- Dynamic form fields will be inserted here based on gender -->
                    </div>
                </div>
                
                <!-- Screen 5: Special Circumstances -->
                <div id="screen-5" class="hidden">
                    <h2 class="text-2xl font-semibold mb-2">Special Circumstances</h2>
                    <p class="text-slate-600 mb-6">Finally, please confirm if any of these less common, but important, situations apply. They can affect the calculation.</p>
                    <div class="space-y-6">
                        <div class="p-4 bg-slate-50 rounded-lg border">
                            <label class="font-medium text-slate-700 block mb-2">Was any ancestral property partitioned by a registered deed or court order before December 20, 2004?</label>
                            <div id="partition-group" class="radio-btn-group flex space-x-4">
                                 <button data-value="true" class="flex-1 p-2 text-center border rounded-lg">Yes</button>
                                 <button data-value="false" class="flex-1 p-2 text-center border rounded-lg selected">No</button>
                            </div>
                        </div>
                         <div class="p-4 bg-slate-50 rounded-lg border">
                            <label class="font-medium text-slate-700 block mb-2">Has any potential heir been legally convicted of murdering the deceased?</label>
                            <div id="murder-group" class="radio-btn-group flex space-x-4">
                                 <button data-value="true" class="flex-1 p-2 text-center border rounded-lg">Yes</button>
                                 <button data-value="false" class="flex-1 p-2 text-center border rounded-lg selected">No</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen 6: Results -->
                <div id="screen-6" class="hidden">
                     <h2 class="text-2xl font-semibold mb-2 text-center">Inheritance Distribution Summary</h2>
                     <p id="results-intro" class="text-slate-600 mb-8 text-center"></p>
                    
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div class="chart-container">
                            <canvas id="distribution-chart"></canvas>
                        </div>
                        <div id="total-value-summary" class="text-center md:text-left">
                            <!-- Summary text will be injected here -->
                        </div>
                    </div>

                    <div class="mt-12">
                         <h3 class="text-xl font-semibold mb-4">Detailed Breakdown</h3>
                         <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold text-slate-600">Heir</th>
                                        <th class="p-3 text-left font-semibold text-slate-600">Share</th>
                                        <th class="p-3 text-right font-semibold text-slate-600">Value (₹)</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    <!-- Results rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div id="navigation-buttons" class="mt-8 flex justify-between">
                    <button id="back-btn" class="py-2 px-6 bg-slate-300 text-slate-800 font-semibold rounded-lg hover:bg-slate-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 disabled:opacity-50" disabled>Back</button>
                    <button id="next-btn" class="py-2 px-6 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50" disabled>Next</button>
                </div>
            </main>
        </div>

        <!-- Percentage Calculator Content -->
        <div id="percentage-calculator-content" class="hidden">
             <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-2">Simple Percentage Tool</h2>
                <p class="text-slate-600 mb-6">Enter numbers (representing shares or parts) for each relative to calculate their percentage of the total. This tool does not use any legal rules.</p>
                
                <div id="percentage-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <!-- Relatives list will be inserted here by JS -->
                </div>

                <div class="mt-6 pt-4 border-t-2 border-slate-200 flex justify-between items-center font-bold text-lg">
                    <span>Total Parts:</span>
                    <span id="total-parts">0</span>
                </div>
                 <div class="mt-2 flex justify-between items-center font-bold text-lg">
                    <span>Total Percentage:</span>
                    <span id="total-percentage">0.00%</span>
                </div>

             </main>
        </div>
        
        <!-- Law Explained Content -->
        <div id="law-explained-content" class="hidden">
             <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold mb-2 text-indigo-700">The Law Explained: A Simple Guide</h2>
                    <p class="text-slate-600">This guide simplifies the key rules of the Hindu Succession Act, 1956, which applies when a Hindu, Sikh, Jain, or Buddhist dies without a valid will.</p>
                </div>

                <div class="flowchart-box space-y-4">
                     <h3 class="text-xl font-bold">Key Concepts</h3>
                     <div>
                        <h4 class="font-semibold text-lg">Self-Acquired Property</h4>
                        <p class="text-slate-600">Property bought with personal income, or received as a gift. The owner has full rights to sell, gift, or will it to anyone.</p>
                     </div>
                      <div>
                        <h4 class="font-semibold text-lg">Ancestral Property</h4>
                        <p class="text-slate-600">Property inherited from a person's father, paternal grandfather, or paternal great-grandfather. Before 2005, only sons had a right to this by birth. The 2005 Amendment gave daughters an equal right by birth.</p>
                     </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold text-center">Succession Flowchart for a <span class="text-indigo-600">Male's</span> Property</h3>
                    
                    <div class="flowchart-box">
                        <h4 class="text-lg font-semibold text-center">Step 1: Look for Class I Heirs</h4>
                        <p class="text-center text-slate-500">(Mother, Widow, Sons, Daughters, and children of any predeceased children)</p>
                    </div>

                    <div class="grid grid-cols-5 items-center">
                        <div class="col-span-2 border-t-2 border-dashed"></div>
                        <div class="flowchart-arrow">↓</div>
                        <div class="col-span-2 border-t-2 border-dashed"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div class="flowchart-box bg-green-50 border-green-300">
                            <h4 class="text-lg font-semibold text-center text-green-800">If YES (Class I Heirs Exist)</h4>
                            <p class="text-green-700 text-center mt-2">The property is divided <strong class="font-bold">equally</strong> among all Class I heirs. They exclude everyone else.</p>
                        </div>
                        <div class="flowchart-box bg-red-50 border-red-300">
                             <h4 class="text-lg font-semibold text-center text-red-800">If NO (No Class I Heirs)</h4>
                            <p class="text-red-700 text-center mt-2">Proceed to the next step.</p>
                        </div>
                    </div>

                    <div class="flowchart-arrow">↓</div>

                     <div class="flowchart-box">
                        <h4 class="text-lg font-semibold text-center">Step 2: Look for Class II Heirs</h4>
                        <p class="text-center text-slate-500">The law lists these in entries. Heirs in a higher entry exclude all heirs in lower entries.</p>
                        <ul class="list-disc list-inside mt-2 text-slate-600 pl-4">
                            <li><strong>Entry I:</strong> Father</li>
                            <li><strong>Entry II:</strong> Siblings (Brothers/Sisters), Son's Daughter's children</li>
                            <li>... and so on.</li>
                        </ul>
                        <p class="mt-2 text-sm text-center">Example: If the Father is alive, he gets everything. Siblings get nothing.</p>
                    </div>
                </div>

                 <div>
                    <h3 class="text-xl font-bold text-center">Succession Flowchart for a <span class="text-indigo-600">Female's</span> Property</h3>
                    <p class="text-center text-slate-500 mb-4">This is more complex and depends on the source of the property.</p>

                    <div class="flowchart-box">
                        <h4 class="text-lg font-semibold text-center">Step 1: Did she leave children or grandchildren?</h4>
                    </div>

                    <div class="grid grid-cols-5 items-center">
                        <div class="col-span-2 border-t-2 border-dashed"></div>
                        <div class="flowchart-arrow">↓</div>
                        <div class="col-span-2 border-t-2 border-dashed"></div>
                    </div>

                     <div class="grid grid-cols-2 gap-4">
                         <div class="flowchart-box bg-green-50 border-green-300">
                            <h4 class="text-lg font-semibold text-center text-green-800">If YES</h4>
                            <p class="text-green-700 text-center mt-2">All her property is divided <strong class="font-bold">equally</strong> between her Husband and her Children (including children of predeceased children).</p>
                        </div>
                        <div class="flowchart-box bg-red-50 border-red-300">
                             <h4 class="text-lg font-semibold text-center text-red-800">If NO (She was childless)</h4>
                            <p class="text-red-700 text-center mt-2">The rules change based on the property's source.</p>
                        </div>
                    </div>
                    
                    <div class="flowchart-arrow">↓</div>

                    <div class="flowchart-box">
                        <h4 class="text-lg font-semibold text-center">Step 2 (Only if childless): Determine Property Source</h4>
                         <div class="mt-4 grid md:grid-cols-3 gap-4">
                            <div class="p-4 border rounded-lg bg-slate-50">
                                <h5 class="font-semibold text-center">Property from Parents</h5>
                                <p class="text-sm text-center mt-1">Goes back to her Father's heirs (e.g., her own siblings).</p>
                            </div>
                             <div class="p-4 border rounded-lg bg-slate-50">
                                <h5 class="font-semibold text-center">Property from Husband/In-laws</h5>
                                <p class="text-sm text-center mt-1">Goes to her Husband's heirs.</p>
                            </div>
                             <div class="p-4 border rounded-lg bg-slate-50">
                                <h5 class="font-semibold text-center">Self-Acquired Property</h5>
                                <p class="text-sm text-center mt-1">Goes to Husband's heirs first. If none, then to her parents. If none, then her father's heirs (siblings).</p>
                            </div>
                        </div>
                    </div>
                </div>

             </main>
        </div>
        
        <footer class="text-center mt-8 text-xs text-slate-500">
            <p>This calculator provides an estimate for informational purposes only and does not constitute legal advice. The calculations are based on the general principles of the Hindu Succession Act, 1956. Please consult a qualified lawyer to address your specific situation.</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    let state = {
        currentScreen: 1,
        deceased: {
            religion: null,
            gender: null,
            deathAfter2005: null,
        },
        family: {},
        specialCircumstances: {
            partitionBefore2004: false,
            murderer: false,
        },
    };
    
    let propertyIdCounter = 0;
    let distributionChart = null;

    const screens = [
        document.getElementById('screen-1'),
        document.getElementById('screen-2'),
        document.getElementById('screen-3'),
        document.getElementById('screen-4'),
        document.getElementById('screen-5'),
        document.getElementById('screen-6')
    ];
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const stepIndicatorContainer = document.getElementById('step-indicator-container');
    const stepIndicators = [
        document.getElementById('step-1-indicator'),
        document.getElementById('step-2-indicator'),
        document.getElementById('step-3-indicator'),
        document.getElementById('step-4-indicator'),
        document.getElementById('step-5-indicator'),
    ];

    const RELIGIONS = [
        { name: 'Hinduism', icon: '🕉️' },
        { name: 'Buddhism', icon: '☸️' },
        { name: 'Jainism', icon: ' जैन' },
        { name: 'Sikhism', icon: '☬' }
    ];
    
    const PERCENTAGE_RELATIVES = [
        'Wife', 'Husband', 'Son 1', 'Son 2', 'Daughter 1', 'Daughter 2', 'Father', 'Mother', 'Brother 1', 'Brother 2', 'Sister 1', 'Sister 2', 'Other 1', 'Other 2'
    ];

    function init() {
        populateReligions();
        setupEventListeners();
        addPropertyCard(); // Add the first property card by default
        initializePercentageCalculator();
        updateUI();
    }
    
    function initializePercentageCalculator() {
        const form = document.getElementById('percentage-form');
        PERCENTAGE_RELATIVES.forEach(relative => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-3 gap-2 items-center';
            div.innerHTML = `
                <label class="font-medium col-span-1">${relative}:</label>
                <input type="number" min="0" value="0" class="percentage-input w-full p-2 border rounded-lg text-right">
                <span class="percentage-display text-right font-semibold text-indigo-600">0.00%</span>
            `;
            form.appendChild(div);
        });
        
        form.addEventListener('input', (e) => {
            if (e.target.classList.contains('percentage-input')) {
                updatePercentages();
            }
        });
    }

    function updatePercentages() {
        const inputs = Array.from(document.querySelectorAll('.percentage-input'));
        const displays = Array.from(document.querySelectorAll('.percentage-display'));
        
        const values = inputs.map(input => parseFloat(input.value) || 0);
        const totalParts = values.reduce((sum, val) => sum + val, 0);

        document.getElementById('total-parts').textContent = totalParts;
        
        if (totalParts === 0) {
            displays.forEach(display => display.textContent = '0.00%');
            document.getElementById('total-percentage').textContent = '0.00%';
            return;
        }

        let totalPercentage = 0;
        values.forEach((val, index) => {
            const percentage = (val / totalParts) * 100;
            totalPercentage += percentage;
            displays[index].textContent = `${percentage.toFixed(2)}%`;
        });
        document.getElementById('total-percentage').textContent = `${totalPercentage.toFixed(2)}%`;
    }

    function populateReligions() {
        const container = document.querySelector('#screen-1 .grid');
        container.innerHTML = '';
        RELIGIONS.forEach(religion => {
            const button = document.createElement('button');
            button.className = 'p-4 border rounded-lg text-center hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 flex flex-col items-center justify-center space-y-2';
            button.dataset.religion = religion.name;
            button.innerHTML = `<span class="text-3xl">${religion.icon}</span><span class="font-medium">${religion.name}</span>`;
            button.addEventListener('click', () => handleReligionSelect(religion.name));
            container.appendChild(button);
        });
    }
    
    function handleReligionSelect(religion) {
        state.deceased.religion = religion;
        const buttons = document.querySelectorAll('#screen-1 .grid button');
        buttons.forEach(btn => btn.classList.toggle('bg-indigo-200', btn.dataset.religion === religion));
        
        const errorDiv = document.getElementById('applicability-error');
        errorDiv.classList.toggle('hidden', religion !== 'Other');
        nextBtn.disabled = religion === 'Other';
    }

    function setupEventListeners() {
        // Tab switching
        const tabLegal = document.getElementById('tab-legal');
        const tabPercentage = document.getElementById('tab-percentage');
        const tabLaw = document.getElementById('tab-law');
        const legalContent = document.getElementById('legal-calculator-content');
        const percentageContent = document.getElementById('percentage-calculator-content');
        const lawContent = document.getElementById('law-explained-content');
        
        tabLegal.addEventListener('click', () => {
            tabLegal.classList.add('active');
            tabPercentage.classList.remove('active');
            tabLaw.classList.remove('active');
            legalContent.classList.remove('hidden');
            percentageContent.classList.add('hidden');
            lawContent.classList.add('hidden');
        });
        
        tabPercentage.addEventListener('click', () => {
            tabPercentage.classList.add('active');
            tabLegal.classList.remove('active');
            tabLaw.classList.remove('active');
            percentageContent.classList.remove('hidden');
            legalContent.classList.add('hidden');
            lawContent.classList.add('hidden');
        });

        tabLaw.addEventListener('click', () => {
            tabLaw.classList.add('active');
            tabLegal.classList.remove('active');
            tabPercentage.classList.remove('active');
            lawContent.classList.remove('hidden');
            legalContent.classList.add('hidden');
            percentageContent.classList.add('hidden');
        });

        // Legal Calculator Listeners
        backBtn.addEventListener('click', () => changeScreen(state.currentScreen - 1));
        nextBtn.addEventListener('click', handleNextClick);
        
        setupRadioGroup('gender-group', value => {
            state.deceased.gender = value;
            buildFamilyTreeForm();
            validateScreen2();
        });
        setupRadioGroup('dod-group', value => {
            state.deceased.deathAfter2005 = (value === 'true');
            validateScreen2();
        });
        setupRadioGroup('partition-group', value => state.specialCircumstances.partitionBefore2004 = (value === 'true'));
        setupRadioGroup('murder-group', value => state.specialCircumstances.murderer = (value === 'true'));

        document.getElementById('add-property-btn').addEventListener('click', addPropertyCard);
    }
    
    function setupRadioGroup(groupId, callback) {
        const group = document.getElementById(groupId);
        if(!group) return;
        group.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const value = e.target.dataset.value;
                Array.from(group.children).forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === value);
                });
                if (callback) callback(value);
            }
        });
    }
    
    function validateScreen2() {
        nextBtn.disabled = !(state.deceased.gender !== null && state.deceased.deathAfter2005 !== null);
    }
    
    function addPropertyCard() {
        propertyIdCounter++;
        const card = document.createElement('div');
        card.className = 'property-card p-6 border rounded-xl bg-slate-50 relative';
        card.id = `property-${propertyIdCounter}`;
        card.innerHTML = `
            <h3 class="font-bold text-lg mb-4">Property ${propertyIdCounter}</h3>
            <button class="delete-property-btn absolute top-4 right-4 text-slate-400 hover:text-red-500 font-bold text-xl">&times;</button>
            <div class="space-y-6">
                <div>
                    <label for="property-value-${propertyIdCounter}" class="font-semibold text-slate-700 block mb-1 required-label">Approximate Current Market Value (₹)</label>
                    <input type="number" id="property-value-${propertyIdCounter}" placeholder="e.g., 5000000" class="property-input w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" data-field="value">
                </div>
                <div>
                    <label class="font-semibold text-slate-700 block mb-2 required-label">How was this property acquired?
                        <span class="help-tooltip text-indigo-500 font-normal"> [?]
                            <span class="tooltiptext">This is the most important question. It determines if a property is "self-acquired" or "ancestral," which completely changes how it is divided.</span>
                        </span>
                    </label>
                    <select id="property-acquisition-${propertyIdCounter}" class="property-input w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white" data-field="acquisition">
                        <option value="">-- Please select --</option>
                        <option value="purchased">Purchased with own money/earnings</option>
                        <option value="gift">Received as a gift</option>
                        <option value="partition">Received during a family partition</option>
                        <option value="inherited">Inherited</option>
                    </select>
                </div>
                <div id="inheritance-source-container-${propertyIdCounter}" class="hidden space-y-4">
                     <div>
                        <label for="property-inheritance-source-${propertyIdCounter}" class="font-semibold text-slate-700 block mb-2 required-label">From whom was it inherited?</label>
                        <select id="property-inheritance-source-${propertyIdCounter}" class="property-input w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white" data-field="inheritanceSource">
                            <option value="">-- Please select --</option>
                            <option value="paternal_grandfather">Paternal Grandfather</option>
                            <option value="paternal_great_grandfather">Paternal Great-Grandfather</option>
                            <option value="father">Father</option>
                            <option value="mother">Mother</option>
                            <option value="husband">Husband</option>
                            <option value="father_in_law">Father-in-law</option>
                            <option value="other">Other Relative</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('property-list').appendChild(card);
        
        card.querySelector(`#property-acquisition-${propertyIdCounter}`).addEventListener('change', (e) => {
           card.querySelector(`#inheritance-source-container-${propertyIdCounter}`).classList.toggle('hidden', e.target.value !== 'inherited');
        });
        
        card.querySelector('.delete-property-btn').addEventListener('click', () => {
            if (document.querySelectorAll('.property-card').length > 1) {
                card.remove();
            } else {
                alert("You must have at least one property.");
            }
        });
    }

    function collectPropertiesData() {
        const propertyCards = document.querySelectorAll('.property-card');
        const properties = [];
        let allValid = true;
        propertyCards.forEach(card => {
            const id = card.id.split('-')[1];
            const value = parseFloat(card.querySelector(`#property-value-${id}`).value);
            const acquisition = card.querySelector(`#property-acquisition-${id}`).value;
            const inheritanceSource = card.querySelector(`#property-inheritance-source-${id}`).value;

            if (isNaN(value) || value <= 0 || !acquisition || (acquisition === 'inherited' && !inheritanceSource)) {
                allValid = false;
            }
            
            properties.push({
                value: value,
                acquisition: acquisition,
                inheritanceSource: acquisition === 'inherited' ? inheritanceSource : null,
            });
        });
        
        if (!allValid) {
            alert("Please fill all required fields for each property before proceeding.");
            return null;
        }
        return properties;
    }

    function buildFamilyTreeForm() {
        const container = document.getElementById('family-tree-form');
        container.innerHTML = '';
        state.family = {}; // Reset family state

        const createRadioInput = (id, labelText, extraClasses = '') => `
            <div class="form-section ${extraClasses}">
                <label class="font-semibold text-slate-700 block mb-2 required-label">${labelText}</label>
                <div id="${id}-group" class="radio-btn-group flex space-x-4">
                    <button data-value="true" class="flex-1 p-2 text-center border rounded-lg">Yes</button>
                    <button data-value="false" class="flex-1 p-2 text-center border rounded-lg selected">No</button>
                </div>
            </div>`;
        
        const createNumericInput = (id, labelText, extraClasses = '') => `
            <div class="form-section ${extraClasses}">
                <label for="${id}" class="font-semibold text-slate-700 block mb-2 required-label">${labelText}</label>
                <input type="number" id="${id}" min="0" value="0" class="w-full p-2 border rounded-lg">
                <div id="${id}-details" class="mt-4 space-y-4"></div>
            </div>`;

        if (state.deceased.gender === 'male') {
            container.innerHTML = `
                <div id="class-I-heirs">
                    <h3 class="text-xl font-semibold text-indigo-600">Class I Heirs</h3>
                    <p class="text-sm text-slate-500 mb-4">These heirs inherit first and exclude all others.</p>
                    ${createRadioInput('mother-alive', "Is the deceased's mother alive?")}
                    ${createRadioInput('widow-alive', 'Was the deceased married (and the widow is alive)?')}
                    ${createNumericInput('living-sons', 'Number of living sons:')}
                    ${createNumericInput('living-daughters', 'Number of living daughters:')}
                    ${createNumericInput('predeceased-sons', 'Number of predeceased sons (who left children/widow):')}
                    ${createNumericInput('predeceased-daughters', 'Number of predeceased daughters (who left children):')}
                </div>
                <div id="class-II-heirs" class="hidden mt-8">
                     <h3 class="text-xl font-semibold text-indigo-600">Class II Heirs</h3>
                    <p class="text-sm text-slate-500 mb-4">Only provide these details if there are <strong class="text-red-600">NO Class I Heirs</strong> listed above.</p>
                    ${createRadioInput('father-alive', "Is the deceased's father alive?", "class-II-entry-I")}
                    <div id="class-II-entry-II-container" class="hidden">
                         ${createNumericInput('brothers', 'Number of brothers:', 'class-II-entry-II')}
                         ${createNumericInput('sisters', 'Number of sisters:', 'class-II-entry-II')}
                    </div>
                </div>
            `;
        } else { // Female
            container.innerHTML = `
                <div id="female-primary-heirs">
                    <h3 class="text-xl font-semibold text-indigo-600">Primary Heirs</h3>
                    <p class="text-sm text-slate-500 mb-4">These heirs inherit first and exclude all others.</p>
                    ${createRadioInput('husband-alive', 'Was the deceased married (and the husband is alive)?')}
                    ${createNumericInput('living-sons', 'Number of living sons:')}
                    ${createNumericInput('living-daughters', 'Number of living daughters:')}
                    ${createNumericInput('female-predeceased-sons', 'Number of predeceased sons (who left children):')}
                    ${createNumericInput('female-predeceased-daughters', 'Number of predeceased daughters (who left children):')}
                </div>
                <div id="female-secondary-heirs" class="hidden mt-8">
                     <h3 class="text-xl font-semibold text-indigo-600">Secondary Heirs</h3>
                    <p class="text-sm text-slate-500 mb-4">Only provide these details if the deceased had <strong class="text-red-600">NO children or grandchildren</strong>.</p>
                    
                    <h4 class="font-semibold text-slate-700 mt-4">Heirs of the Husband</h4>
                    <p class="text-xs text-slate-500 mb-2">These heirs may inherit self-acquired property and property inherited from the husband's family.</p>
                    ${createNumericInput('husband-heirs', 'Number of husband\'s heirs (e.g., his brother/sister):', 'secondary-heir-field')}

                    <h4 class="font-semibold text-slate-700 mt-4">Parents of the Deceased</h4>
                    ${createRadioInput('female-father-alive', 'Is her father alive?', 'secondary-heir-field')}
                    ${createRadioInput('female-mother-alive', 'Is her mother alive?', 'secondary-heir-field')}

                    <h4 class="font-semibold text-slate-700 mt-4">Heirs of the Father (Siblings of the Deceased)</h4>
                    <p class="text-xs text-slate-500 mb-2">These heirs (e.g. her siblings) may inherit property that came from the deceased's parents.</p>
                    ${createNumericInput('female-brothers', 'Number of her brothers:', 'secondary-heir-field')}
                    ${createNumericInput('female-sisters', 'Number of her sisters:', 'secondary-heir-field')}

                    <h4 class="font-semibold text-slate-700 mt-4">Heirs of the Mother</h4>
                    <p class="text-xs text-slate-500 mb-2">These heirs inherit only if no other heirs listed above exist.</p>
                    ${createNumericInput('mother-heirs', 'Number of mother\'s heirs:', 'secondary-heir-field')}
                </div>
            `;
        }
        
        attachFamilyTreeListeners();
    }

    function attachFamilyTreeListeners() {
        const container = document.getElementById('family-tree-form');

        const checkHeirs = () => {
             if (state.deceased.gender === 'male') {
                let hasClassI = false;
                if(document.querySelector('#mother-alive-group button.selected[data-value="true"]')) hasClassI = true;
                if(document.querySelector('#widow-alive-group button.selected[data-value="true"]')) hasClassI = true;
                if(parseInt(document.getElementById('living-sons').value) > 0) hasClassI = true;
                if(parseInt(document.getElementById('living-daughters').value) > 0) hasClassI = true;
                if(parseInt(document.getElementById('predeceased-sons').value) > 0) hasClassI = true;
                if(parseInt(document.getElementById('predeceased-daughters').value) > 0) hasClassI = true;
                document.getElementById('class-II-heirs').classList.toggle('hidden', hasClassI);
                
                const fatherAlive = document.querySelector('#father-alive-group button.selected[data-value="true"]');
                document.getElementById('class-II-entry-II-container').classList.toggle('hidden', !!fatherAlive);

             } else { // Female
                let hasChildren = false;
                if(parseInt(document.getElementById('living-sons').value) > 0) hasChildren = true;
                if(parseInt(document.getElementById('living-daughters').value) > 0) hasChildren = true;
                if(parseInt(document.getElementById('female-predeceased-sons').value) > 0) hasChildren = true;
                if(parseInt(document.getElementById('female-predeceased-daughters').value) > 0) hasChildren = true;
                document.getElementById('female-secondary-heirs').classList.toggle('hidden', hasChildren);
             }
        };
        
        container.addEventListener('input', checkHeirs);
        container.addEventListener('click', (e) => {
            if (e.target.closest('.radio-btn-group')) {
                setTimeout(checkHeirs, 50);
            }
        });
        
        setupRadioGroup('father-alive-group');

        const numericInputs = ['living-sons', 'living-daughters', 'predeceased-sons', 'predeceased-daughters', 'female-predeceased-sons', 'female-predeceased-daughters'];
        numericInputs.forEach(id => {
            const inputEl = document.getElementById(id);
            if (inputEl) {
                inputEl.addEventListener('input', (e) => {
                    if (id.includes('predeceased')) {
                       generatePredeceasedDetails(id, parseInt(e.target.value) || 0);
                    }
                });
            }
        });

        const radioIds = ['mother-alive', 'widow-alive', 'husband-alive', 'female-father-alive', 'female-mother-alive'];
        radioIds.forEach(id => setupRadioGroup(`${id}-group`));
    }

    function generatePredeceasedDetails(type, count) {
        const container = document.getElementById(`${type}-details`);
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'p-4 border rounded-lg bg-slate-50';
            const sonOrDaughter = type.includes('son') ? 'son' : 'daughter';
            let html = `<h4 class="font-semibold">Details for Predeceased ${sonOrDaughter} #${i}</h4><div class="mt-2 space-y-3">`;
            if (sonOrDaughter === 'son') {
                 html += `<div><label class="font-medium block mb-2 required-label">Widow is alive?</label><div id="${type}-${i}-widow-alive-group" class="radio-btn-group flex space-x-4"><button data-value="true" class="flex-1 p-2 text-center border rounded-lg">Yes</button><button data-value="false" class="flex-1 p-2 text-center border rounded-lg selected">No</button></div></div>`;
            }
            html += `<div><label class="font-medium block mb-1 required-label">Number of sons:</label><input type="number" min="0" value="0" class="w-full p-1 border rounded" id="${type}-${i}-sons"></div>`;
            html += `<div><label class="font-medium block mb-1 required-label">Number of daughters:</label><input type="number" min="0" value="0" class="w-full p-1 border rounded" id="${type}-${i}-daughters"></div>`;
            html += `</div>`;
            detailsDiv.innerHTML = html;
            container.appendChild(detailsDiv);
            if(sonOrDaughter === 'son') {
                setupRadioGroup(`${type}-${i}-widow-alive-group`);
            }
        }
    }

    function collectFamilyData() {
        const family = {};
        const getRadioValue = (id) => {
            const group = document.getElementById(`${id}-group`);
            if(!group) return null;
            const selectedBtn = group.querySelector('button.selected');
            return selectedBtn ? (selectedBtn.dataset.value === 'true') : null;
        };
        const getNumValue = (id) => parseInt(document.getElementById(id)?.value) || 0;
        
        const getPredeceasedData = (prefix) => {
            const list = [];
            const count = getNumValue(prefix);
            for(let i=1; i<=count; i++) {
                let entry = {
                    sons: getNumValue(`${prefix}-${i}-sons`),
                    daughters: getNumValue(`${prefix}-${i}-daughters`),
                };
                if(prefix.includes('son')) {
                    entry.widowAlive = getRadioValue(`${prefix}-${i}-widow-alive`);
                }
                list.push(entry);
            }
            return list;
        };

        family.livingSons = getNumValue('living-sons');
        family.livingDaughters = getNumValue('living-daughters');

        if (state.deceased.gender === 'male') {
            family.motherAlive = getRadioValue('mother-alive');
            family.widowAlive = getRadioValue('widow-alive');
            family.predeceasedSons = getPredeceasedData('predeceased-sons');
            family.predeceasedDaughters = getPredeceasedData('predeceased-daughters');
            family.fatherAlive = getRadioValue('father-alive');
            family.brothers = getNumValue('brothers');
            family.sisters = getNumValue('sisters');
        } else { // Female
             family.husbandAlive = getRadioValue('husband-alive');
             family.predeceasedSons = getPredeceasedData('female-predeceased-sons');
             family.predeceasedDaughters = getPredeceasedData('female-predeceased-daughters');
             family.husbandHeirs = getNumValue('husband-heirs');
             family.fatherAlive = getRadioValue('female-father-alive');
             family.motherAlive = getRadioValue('female-mother-alive');
             family.brothers = getNumValue('female-brothers');
             family.sisters = getNumValue('female-sisters');
             family.motherHeirs = getNumValue('mother-heirs');
        }
        state.family = family;
    }

    function handleNextClick() {
        if(state.currentScreen === 3) {
            const properties = collectPropertiesData();
            if(!properties) return;
        }
        if (state.currentScreen === 4) {
            collectFamilyData();
        }
        if (state.currentScreen === 5) {
            calculateAndShowResults();
        } else {
            changeScreen(state.currentScreen + 1);
        }
    }

    function changeScreen(targetScreen) {
        state.currentScreen = targetScreen;
        updateUI();
        window.scrollTo(0, 0);
    }
    
    function updateUI() {
        screens.forEach((screen, index) => {
            screen.classList.toggle('hidden', index + 1 !== state.currentScreen);
        });

        stepIndicatorContainer.classList.toggle('hidden', state.currentScreen === 6);
        stepIndicators.forEach((indicator, index) => {
            indicator.classList.remove('active', 'completed');
            if (index < state.currentScreen - 1) {
                indicator.classList.add('completed');
                indicator.innerHTML = `&#10003;`;
            } else if (index === state.currentScreen - 1) {
                 indicator.classList.add('active');
                 indicator.textContent = index + 1;
            } else {
                 indicator.textContent = index + 1;
            }
        });
        
        backBtn.disabled = state.currentScreen === 1;
        
        if (state.currentScreen === 6) { // Results screen
            nextBtn.classList.add('hidden');
            backBtn.textContent = 'Start Over';
            const newBackBtn = backBtn.cloneNode(true);
            backBtn.parentNode.replaceChild(newBackBtn, backBtn);
            newBackBtn.addEventListener('click', () => window.location.reload());
        } else {
            nextBtn.textContent = (state.currentScreen === 5) ? 'Calculate' : 'Next';
            nextBtn.classList.remove('hidden');
            backBtn.textContent = 'Back';
        }
        
        if (state.currentScreen === 1) nextBtn.disabled = !state.deceased.religion;
        if (state.currentScreen === 2) validateScreen2();
        if (state.currentScreen === 3) nextBtn.disabled = false; // Validation is now on 'Next' click
        if (state.currentScreen >= 4) nextBtn.disabled = false;
    }

    function calculateAndShowResults() {
        const properties = collectPropertiesData();
        if(!properties) return; // Stop if properties are invalid
        const results = calculateInheritance(state, properties);
        renderResults(results);
        changeScreen(6);
    }
    
    function renderResults(results) {
        const totalValue = results.totalValue;
        document.getElementById('results-intro').textContent = `Based on the information provided, the total estimated value of the estate is ₹${totalValue.toLocaleString('en-IN')}. The distribution among the legal heirs is as follows:`;

        const summaryContainer = document.getElementById('total-value-summary');
        summaryContainer.innerHTML = `
            <p class="text-lg text-slate-600">Total Estate Value</p>
            <p class="text-4xl md:text-5xl font-bold text-indigo-700 mt-2 mb-4">₹${totalValue.toLocaleString('en-IN')}</p>
            <p class="text-slate-500">${results.heirs.length} legal heir(s) identified.</p>
        `;

        const tableBody = document.getElementById('results-table-body');
        tableBody.innerHTML = '';
        results.heirs.forEach(heir => {
            const row = document.createElement('tr');
            row.className = 'border-b';
            row.innerHTML = `
                <td class="p-3">
                    <p class="font-semibold">${heir.name}</p>
                    <p class="text-sm text-slate-500">${heir.relationship}</p>
                </td>
                <td class="p-3">
                    <p class="font-semibold">${(heir.share * 100).toFixed(2)}%</p>
                    <p class="text-sm text-slate-500">${heir.shareFraction}</p>
                </td>
                <td class="p-3 text-right">
                    <p class="font-semibold">₹${heir.value.toLocaleString('en-IN')}</p>
                </td>
            `;
            tableBody.appendChild(row);

            if(heir.notes) {
                const notesRow = document.createElement('tr');
                notesRow.innerHTML = `<td colspan="3" class="p-3 pt-0 text-sm text-slate-600 bg-slate-50"><span class="font-semibold">Note:</span> ${heir.notes}</td>`;
                tableBody.appendChild(notesRow);
            }
        });

        const chartLabels = results.heirs.map(h => `${h.name} (${h.relationship})`);
        const chartData = results.heirs.map(h => h.share);
        const chartColors = generateColors(results.heirs.length);

        if (distributionChart) {
            distributionChart.destroy();
        }
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        distributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Inheritance Share',
                    data: chartData,
                    backgroundColor: chartColors,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 12 }, boxWidth: 20 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-IN', { style: 'percent', minimumFractionDigits: 2 }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function generateColors(numColors) {
        const colors = [];
        const baseColors = ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6', '#ef4444', '#64748b'];
        for(let i = 0; i < numColors; i++) {
            colors.push(baseColors[i % baseColors.length]);
        }
        return colors;
    }
    
    function calculateInheritance(s, properties) {
        const { deceased, family, specialCircumstances } = s;
        let finalHeirs = {}; 
        let totalValue = properties.reduce((acc, p) => acc + (p.value || 0), 0);

        const addShare = (name, relationship, shareValue, notes) => {
            if (specialCircumstances.murderer) return; // Disqualified
            if (!finalHeirs[name]) {
                finalHeirs[name] = { name, relationship, value: 0, notes: '' };
            }
            finalHeirs[name].value += shareValue;
            if (notes && !finalHeirs[name].notes.includes(notes)) {
                 finalHeirs[name].notes += notes + ' ';
            }
        };
        
        const distributePerStirpes = (sharePerBranch, predeceasedHeirs, namePrefix, note) => {
             predeceasedHeirs.forEach((heir, i) => {
                let shareForBranch = sharePerBranch;
                let branchMembers = (heir.widowAlive ? 1 : 0) + heir.sons + heir.daughters;
                if(namePrefix === 'Daughter') branchMembers = heir.sons + heir.daughters; 

                if (branchMembers > 0) {
                    const subShare = shareForBranch / branchMembers;
                    if(heir.widowAlive && namePrefix === 'Son') addShare(`Predeceased Son ${i+1}'s Widow`, 'Class I Heir', subShare, note);
                    for(let j=0; j<heir.sons; j++) addShare(`Grandson (from P${namePrefix[0]}${i+1})`, `Predeceased ${namePrefix}'s Son`, subShare, note);
                    for(let j=0; j<heir.daughters; j++) addShare(`Granddaughter (from P${namePrefix[0]}${i+1})`, `Predeceased ${namePrefix}'s Daughter`, subShare, note);
                }
            });
        };

        if (deceased.gender === 'male') {
            properties.forEach(property => {
                let isAncestral = ['paternal_grandfather', 'paternal_great_grandfather', 'father'].includes(property.inheritanceSource);
                let devisableValue = property.value;
                if (isAncestral && deceased.deathAfter2005 && !specialCircumstances.partitionBefore2004) {
                    let coparceners = 1 + family.livingSons + family.livingDaughters; 
                    let deceasedNotionalShare = property.value / coparceners;
                    devisableValue = deceasedNotionalShare;
                    for(let i=0; i<family.livingSons; i++) addShare(`Son ${i+1}`, 'Coparcener', deceasedNotionalShare, 'Receives direct share as a coparcener (Sec. 6, HSA, 1956).');
                    for(let i=0; i<family.livingDaughters; i++) addShare(`Daughter ${i+1}`, 'Coparcener', deceasedNotionalShare, 'Receives direct share as a coparcener (2005 Amendment, Sec. 6, HSA, 1956).');
                }
                
                let class1Branches = (family.motherAlive ? 1 : 0) + (family.widowAlive ? 1 : 0) + family.livingSons + family.livingDaughters + family.predeceasedSons.length + family.predeceasedDaughters.length;

                if (class1Branches > 0) {
                    const sharePerBranch = devisableValue / class1Branches;
                    if (family.motherAlive) addShare('Mother', 'Class I Heir', sharePerBranch, 'Inherits as a Class I heir (Sec. 8, HSA, 1956).');
                    if (family.widowAlive) addShare('Widow', 'Class I Heir', sharePerBranch, 'Inherits as a Class I heir (Sec. 8, HSA, 1956).');
                    for(let i=0; i<family.livingSons; i++) addShare(`Son ${i+1}`, 'Class I Heir', sharePerBranch, 'Inherits from separate/notional property (Sec. 8, HSA, 1956).');
                    for(let i=0; i<family.livingDaughters; i++) addShare(`Daughter ${i+1}`, 'Class I Heir', sharePerBranch, 'Inherits from separate/notional property (Sec. 8, HSA, 1956).');
                    distributePerStirpes(sharePerBranch, family.predeceasedSons, 'Son', 'Inherits per stirpes (Sec. 10, Rule 4, HSA, 1956).');
                    distributePerStirpes(sharePerBranch, family.predeceasedDaughters, 'Daughter', 'Inherits per stirpes (Sec. 10, Rule 4, HSA, 1956).');
                } else if(family.fatherAlive) {
                     addShare('Father', 'Class II Heir (Entry I)', devisableValue, 'Inherits as the sole Class II, Entry I heir (Sec. 8, HSA, 1956).');
                } else if(family.brothers > 0 || family.sisters > 0) {
                    const numHeirs = family.brothers + family.sisters;
                    const share = devisableValue / numHeirs;
                    for(let i=0; i<family.brothers; i++) addShare(`Brother ${i+1}`, 'Class II Heir (Entry II)', share, 'Inherits as a Class II, Entry II heir (Sec. 8 & 11, HSA, 1956).');
                    for(let i=0; i<family.sisters; i++) addShare(`Sister ${i+1}`, 'Class II Heir (Entry II)', share, 'Inherits as a Class II, Entry II heir (Sec. 8 & 11, HSA, 1956).');
                }
            });
        } else { // Female
            const hasChildren = family.livingSons > 0 || family.livingDaughters > 0 || family.predeceasedSons.length > 0 || family.predeceasedDaughters.length > 0;
            properties.forEach(property => {
                if (hasChildren) {
                    let mainBranches = (family.husbandAlive ? 1 : 0) + family.livingSons + family.livingDaughters + family.predeceasedSons.length + family.predeceasedDaughters.length;
                    const sharePerBranch = property.value / mainBranches;
                    if (family.husbandAlive) addShare('Husband', 'Primary Heir', sharePerBranch, 'Inherits u/s 15(1)(a), HSA, 1956.');
                    for(let i=0; i<family.livingSons; i++) addShare(`Son ${i+1}`, 'Primary Heir', sharePerBranch, 'Inherits u/s 15(1)(a), HSA, 1956.');
                    for(let i=0; i<family.livingDaughters; i++) addShare(`Daughter ${i+1}`, 'Primary Heir', sharePerBranch, 'Inherits u/s 15(1)(a), HSA, 1956.');
                    distributePerStirpes(sharePerBranch, family.predeceasedSons, 'Son', 'Inherits per stirpes u/s 15(1)(a) & 16, HSA, 1956.');
                    distributePerStirpes(sharePerBranch, family.predeceasedDaughters, 'Daughter', 'Inherits per stirpes u/s 15(1)(a) & 16, HSA, 1956.');
                } else {
                    const source = property.inheritanceSource;
                    if ((source === 'father' || source === 'mother')) {
                        let fatherHeirsCount = (family.fatherAlive ? 1 : 0) + family.brothers + family.sisters;
                        if (fatherHeirsCount > 0) {
                           const share = property.value / fatherHeirsCount;
                           if (family.fatherAlive) addShare('Father', 'Heir of Father', share, 'Property inherited from parents reverts to father\'s line (Sec. 15(2)(a), HSA, 1956).');
                           for(let i=0; i<family.brothers; i++) addShare(`Brother ${i+1}`, 'Heir of Father', share, 'Property inherited from parents reverts to father\'s line (Sec. 15(2)(a), HSA, 1956).');
                           for(let i=0; i<family.sisters; i++) addShare(`Sister ${i+1}`, 'Heir of Father', share, 'Property inherited from parents reverts to father\'s line (Sec. 15(2)(a), HSA, 1956).');
                        }
                    } else if ((source === 'husband' || source === 'father_in_law')) {
                        if (family.husbandHeirs > 0) {
                            const share = property.value / family.husbandHeirs;
                            for(let i=0; i<family.husbandHeirs; i++) addShare(`Husband's Heir ${i+1}`, 'Heir of Husband', share, 'Property from husband\'s family reverts to his line (Sec. 15(2)(b), HSA, 1956).');
                        }
                    } else { // Self-acquired property general order
                        if (family.husbandHeirs > 0) {
                           const share = property.value / family.husbandHeirs;
                           for(let i=0; i<family.husbandHeirs; i++) addShare(`Husband's Heir ${i+1}`, 'Heir of Husband', share, 'Inherits as heir of husband (Sec. 15(1)(b), HSA, 1956).');
                        } else if (family.motherAlive || family.fatherAlive) {
                           const parentCount = (family.motherAlive ? 1 : 0) + (family.fatherAlive ? 1 : 0);
                           const share = property.value / parentCount;
                           if(family.motherAlive) addShare('Mother', 'Parent', share, 'Inherits as parent (Sec. 15(1)(c), HSA, 1956).');
                           if(family.fatherAlive) addShare('Father', 'Parent', share, 'Inherits as parent (Sec. 15(1)(c), HSA, 1956).');
                        } else if (family.brothers > 0 || family.sisters > 0) {
                           const fatherHeirsCount = family.brothers + family.sisters;
                           const share = property.value / fatherHeirsCount;
                           for(let i=0; i<family.brothers; i++) addShare(`Brother ${i+1}`, 'Heir of Father', share, 'Inherits as heir of father (Sec. 15(1)(d), HSA, 1956).');
                           for(let i=0; i<family.sisters; i++) addShare(`Sister ${i+1}`, 'Heir of Father', share, 'Inherits as heir of father (Sec. 15(1)(d), HSA, 1956).');
                        } else if (family.motherHeirs > 0) {
                           const share = property.value / family.motherHeirs;
                           for(let i=0; i<family.motherHeirs; i++) addShare(`Mother's Heir ${i+1}`, 'Heir of Mother', share, 'Inherits as heir of mother (Sec. 15(1)(e), HSA, 1956).');
                        }
                    }
                }
            });
        }

        const heirArray = Object.values(finalHeirs).map(h => {
             const getFraction = (decimal, total) => {
                 if(total === 0 || decimal === 0) return "0/1";
                 const val = decimal/total;
                 for (let d = 1; d <= 200; d++) { for (let n = 1; n <= d; n++) { if (Math.abs(val - n / d) < 1e-6) return `${n}/${d}`; } }
                 return `${(val*100).toFixed(1)}%`;
             }
            return {
                ...h,
                share: totalValue > 0 ? h.value / totalValue : 0,
                shareFraction: getFraction(h.value, totalValue)
            };
        });

        return { heirs: heirArray.filter(h => h.value > 0.001), totalValue: totalValue };
    }

    init();
});
</script>

</body>
</html>
