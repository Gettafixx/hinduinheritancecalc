<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hindu Inheritance Calculator</title>
    <!-- Chosen Palette: Serene Neutrals & Soft Accents -->
    <!-- Application Structure Plan: A tabbed SPA with three modes. 1) "Comprehensive Calculator": A multi-step wizard for detailed calculations including property values. 2) "Quick Calculation": A single-page tool to quickly determine share distribution. 3) "How It Works": A visual flowchart explaining the legal logic. This structure caters to users needing a full financial breakdown, a quick answer, or an educational overview. -->
    <!-- Visualization & Content Choices: The application uses a combination of interactive elements. For user input (Goal: Guide/Inform), it employs styled HTML forms, radio buttons, and number inputs with plus/minus controls. The "How It Works" tab uses structured HTML and Tailwind CSS to create a flowchart, visually representing the complex succession rules without using images. For the final output (Goal: Compare/Analyze), a dynamic donut chart and a detailed HTML table provide precise breakdowns with clear technical explanations for each heir's status. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fraction.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #333333;
        }
        .step-card {
            background-color: #FFFFFF;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            border: 1px solid #E5E7EB;
        }
        .btn-primary {
            background-color: #4A90E2;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #357ABD;
        }
        .btn-primary:disabled {
            background-color: #A0AEC0;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #F3F4F6;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            border: 1px solid #D1D5DB;
        }
        .btn-secondary:hover {
            background-color: #E5E7EB;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background-color: #F9FAFB;
        }
        .radio-label {
            display: block;
            cursor: pointer;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #E5E7EB;
            transition: all 0.2s ease-in-out;
        }
        .radio-label:hover {
            border-color: #4A90E2;
        }
        input[type="radio"]:checked + .radio-label {
            border-color: #4A90E2;
            background-color: #EFF6FF;
            box-shadow: 0 0 0 2px #4A90E2;
        }
        .progress-bar {
            width: 100%;
            background-color: #E5E7EB;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #4A90E2;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .count-btn {
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.5rem;
            line-height: 1;
            border-radius: 9999px;
            background-color: #E5E7EB;
            color: #374151;
            transition: background-color 0.2s;
        }
        .count-btn:hover {
            background-color: #D1D5DB;
        }
        .count-display {
            font-size: 1.5rem;
            font-weight: 600;
            min-width: 3rem;
            text-align: center;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            color: #6B7280;
        }
        .tab-btn.active {
            color: #4A90E2;
            border-bottom-color: #4A90E2;
            font-weight: 600;
        }
        .flow-node {
            border: 2px solid #A0AEC0;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: white;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .flow-node.decision {
            border-color: #F5A623;
            background-color: #FEF3C7;
        }
        .flow-node.process {
            border-color: #4A90E2;
            background-color: #EFF6FF;
        }
        .flow-node.result {
            border-color: #50E3C2;
            background-color: #ECFDF5;
        }
        .flow-arrow {
            position: relative;
            width: 2px;
            background-color: #9CA3AF;
            margin: 0.5rem auto;
            flex-grow: 1;
        }
        .flow-arrow::after {
            content: '';
            position: absolute;
            left: -5px;
            bottom: -1px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #9CA3AF;
        }
        .flow-arrow-horizontal {
             position: relative;
            height: 2px;
            background-color: #9CA3AF;
            margin: auto 0.5rem;
            flex-grow: 1;
        }
        .flow-arrow-horizontal::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -1px;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #9CA3AF;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Hindu Inheritance Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">An informational tool for intestate succession under the Hindu Succession Act, 1956.</p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-2 md:space-x-4" aria-label="Tabs">
                <button id="comprehensive-tab" class="tab-btn active" role="tab" aria-selected="true" aria-controls="comprehensive-panel">Comprehensive Calculator</button>
                <button id="quick-tab" class="tab-btn" role="tab" aria-selected="false" aria-controls="quick-panel">Quick Calculation</button>
                <button id="how-it-works-tab" class="tab-btn" role="tab" aria-selected="false" aria-controls="how-it-works-panel">How It Works</button>
            </nav>
        </div>

        <div id="comprehensive-panel" role="tabpanel">
            <div id="calculator-app" class="space-y-8">
                <div id="progress-container" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span id="progress-text" class="text-sm font-medium text-gray-600"></span>
                        <span id="progress-percent" class="text-sm font-bold text-gray-800"></span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-bar-inner" class="progress-bar-inner" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Step 1: Deceased Profile -->
                <div id="step-1" class="step-card p-6 md:p-8 hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-center">About the Deceased</h2>
                    <div class="space-y-8">
                         <div>
                            <label class="font-semibold text-gray-800">What was the gender of the deceased?</label>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="radio" name="gender" id="gender-male" value="male" class="hidden">
                                <label for="gender-male" class="radio-label text-center">Male</label>
                                <input type="radio" name="gender" id="gender-female" value="female" class="hidden">
                                <label for="gender-female" class="radio-label text-center">Female</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-800 flex items-center">When did the person pass away?</label>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="radio" name="death_date_period" id="death-after" value="after" class="hidden">
                                <label for="death-after" class="radio-label text-center">On or after Sep 9, 2005</label>
                                <input type="radio" name="death_date_period" id="death-before" value="before" class="hidden">
                                <label for="death-before" class="radio-label text-center">Before Sep 9, 2005</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-800 flex items-center">Was anyone pregnant with the deceased's child at the time of their death?</label>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="radio" name="pregnant" id="pregnant-no" value="no" class="hidden">
                            <label for="pregnant-no" class="radio-label text-center">No</label>
                            <input type="radio" name="pregnant" id="pregnant-yes" value="yes" class="hidden">
                            <label for="pregnant-yes" class="radio-label text-center">Yes</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end mt-8">
                        <button id="next-step-1" class="btn-primary" disabled>Next</button>
                    </div>
                </div>

                <!-- Step 2: Property Inventory -->
                <div id="step-2" class="step-card p-6 md:p-8 hidden">
                    <h2 class="text-2xl font-semibold mb-2 text-center">Property Inventory</h2>
                    <p class="text-gray-600 mb-6 text-center">Please provide details for each property left by the deceased.</p>
                    <div id="property-list-container" class="space-y-6"></div>
                    <div class="text-center my-6">
                        <button id="add-another-property-btn" class="btn-secondary">
                            <span class="flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                Add Another Property
                            </span>
                        </button>
                    </div>
                    <div id="partition-question-container" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <label class="font-semibold text-gray-800 flex items-center">Was a formal partition of any ancestral family property completed and legally registered before December 20, 2004?</label>
                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="radio" name="partition" id="partition-yes" value="yes" class="hidden">
                            <label for="partition-yes" class="radio-label text-center">Yes</label>
                            <input type="radio" name="partition" id="partition-no" value="no" class="hidden">
                            <label for="partition-no" class="radio-label text-center">No</label>
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="navigateSteps(-1)" class="btn-secondary">Back</button>
                        <button id="next-step-2" class="btn-primary" disabled>Next</button>
                    </div>
                </div>

                <!-- Step 3: Heir Identification -->
                <div id="step-3" class="step-card p-6 md:p-8 hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Heir Identification</h2>
                    <p class="text-center text-gray-600 mb-6">Use the `+` and `-` buttons to specify the number of living relatives. If an heir is deceased, leave their count at 0.</p>
                    <div id="heir-form-container" class="space-y-4"></div>
                    <div class="flex justify-between mt-8">
                        <button onclick="navigateSteps(-1)" class="btn-secondary">Back</button>
                        <button id="next-step-3" class="btn-primary">Calculate Shares</button>
                    </div>
                </div>
                
                <!-- Step 4: Results -->
                <div id="step-4" class="step-card p-6 md:p-8 hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Inheritance Distribution Results</h2>
                    <div id="results-container" class="space-y-8"></div>
                    <div class="text-center mt-8 space-x-4">
                        <button onclick="restart()" class="btn-secondary">Start Over</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quick-panel" class="hidden" role="tabpanel">
             <div class="step-card p-6 md:p-8">
                <div id="quick-calc-setup">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Quick Share Calculation</h2>
                    <div class="space-y-8">
                        <div>
                            <label class="font-semibold text-gray-800">Gender of the Deceased</label>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="radio" name="quick_gender" id="quick-gender-male" value="male" class="hidden">
                                <label for="quick-gender-male" class="radio-label text-center">Male</label>
                                <input type="radio" name="quick_gender" id="quick-gender-female" value="female" class="hidden">
                                <label for="quick-gender-female" class="radio-label text-center">Female</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="quick-heir-form-container" class="space-y-4 mt-6 hidden"></div>
                 <div id="quick-calc-button-container" class="text-center mt-8 hidden">
                     <button id="calculate-quick-shares-btn" class="btn-primary">Calculate Shares</button>
                 </div>
                <div id="quick-results-container" class="mt-8"></div>
             </div>
        </div>
        
        <div id="how-it-works-panel" class="hidden" role="tabpanel">
            <div class="step-card p-6 md:p-8">
                <h2 class="text-2xl font-semibold mb-6 text-center">How the Calculation Works</h2>
                <p class="text-center text-gray-600 mb-8">The Hindu Succession Act, 1956 lays down a clear hierarchy for property distribution. The process depends entirely on the gender of the deceased.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Male Flowchart -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-center text-blue-600">If the Deceased is MALE</h3>
                        <div class="flex flex-col items-center">
                            <div class="flow-node process w-full">Identify Deceased's Gender: Male</div>
                            <div class="flow-arrow h-6"></div>
                            <div class="flow-node decision w-full">Are there any Class I Heirs?</div>
                            <div class="flex w-full mt-4">
                                <div class="flex-1 flex flex-col items-center px-2">
                                    <div class="font-bold text-green-600">YES</div>
                                    <div class="flow-arrow h-4"></div>
                                    <div class="flow-node result w-full text-sm">Property is divided ONLY among Class I heirs (Mother, Widow, Sons, Daughters, and branches of predeceased children). Each takes one equal share.</div>
                                </div>
                                <div class="flex-1 flex flex-col items-center px-2">
                                    <div class="font-bold text-red-600">NO</div>
                                    <div class="flow-arrow h-4"></div>
                                     <div class="flow-node decision w-full text-sm">Is the Father (Class II, Entry I) alive?</div>
                                     <div class="flex w-full mt-4">
                                        <div class="flex-1 flex flex-col items-center px-1">
                                            <div class="font-bold text-green-600 text-xs">YES</div>
                                            <div class="flow-arrow h-2"></div>
                                            <div class="flow-node result w-full text-xs">Father inherits 100% of the property.</div>
                                        </div>
                                         <div class="flex-1 flex flex-col items-center px-1">
                                            <div class="font-bold text-red-600 text-xs">NO</div>
                                            <div class="flow-arrow h-2"></div>
                                            <div class="flow-node result w-full text-xs">Property goes to Class II, Entry II heirs (Brother, Sister, etc.) who share equally.</div>
                                        </div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Female Flowchart -->
                     <div class="space-y-4">
                        <h3 class="text-xl font-bold text-center text-pink-600">If the Deceased is FEMALE</h3>
                        <div class="flex flex-col items-center">
                            <div class="flow-node process w-full">Identify Deceased's Gender: Female</div>
                            <div class="flow-arrow h-6"></div>
                            <div class="flow-node decision w-full">How was the property acquired?</div>
                             <div class="flow-arrow h-6"></div>
                            <div class="flow-node decision w-full">Did she have any children or children of predeceased children?</div>
                             <div class="flex w-full mt-4">
                                <div class="flex-1 flex flex-col items-center px-2">
                                    <div class="font-bold text-green-600">YES</div>
                                    <div class="flow-arrow h-4"></div>
                                    <div class="flow-node result w-full text-sm">ALL property is divided equally among her Husband and her Children (and their branches).</div>
                                </div>
                                <div class="flex-1 flex flex-col items-center px-2">
                                    <div class="font-bold text-red-600">NO</div>
                                    <div class="flow-arrow h-4"></div>
                                     <div class="flow-node result w-full text-sm">
                                        <p><span class="font-bold">Self-acquired property</span> goes to her husband's heirs.</p>
                                        <p class="mt-2"><span class="font-bold">Property inherited from parents</span> reverts to her father's heirs.</p>
                                        <p class="mt-2"><span class="font-bold">Property inherited from husband/in-laws</span> reverts to her husband's heirs.</p>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden items-center justify-center z-50">
            <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>
                    </div>
                    <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2">Notice</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="modal-message" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="btn-primary w-full">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; 2024 Hindu Inheritance Calculator. An informational tool. Not legal advice.</p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const state = {
        currentStep: 1,
        totalSteps: 4,
        deceased: {},
        properties: [],
        heirs: {},
        results: {}
    };
    
    const quickState = {
        gender: null,
        heirs: {},
        results: {}
    };

    const elements = {
        app: document.getElementById('calculator-app'),
        steps: Array.from({ length: state.totalSteps + 1 }, (_, i) => document.getElementById(`step-${i + 1}`)),
        progressContainer: document.getElementById('progress-container'),
        progressText: document.getElementById('progress-text'),
        progressPercent: document.getElementById('progress-percent'),
        progressBarInner: document.getElementById('progress-bar-inner'),
        
        genderRadios: document.querySelectorAll('input[name="gender"]'),
        deathDateRadios: document.querySelectorAll('input[name="death_date_period"]'),
        pregnantRadios: document.querySelectorAll('input[name="pregnant"]'),
        nextStep1Btn: document.getElementById('next-step-1'),

        propertyListContainer: document.getElementById('property-list-container'),
        addAnotherPropertyBtn: document.getElementById('add-another-property-btn'),
        partitionQuestionContainer: document.getElementById('partition-question-container'),
        partitionRadios: document.querySelectorAll('input[name="partition"]'),
        nextStep2Btn: document.getElementById('next-step-2'),
        
        heirFormContainer: document.getElementById('heir-form-container'),
        nextStep3Btn: document.getElementById('next-step-3'),

        resultsContainer: document.getElementById('results-container'),
        
        comprehensiveTab: document.getElementById('comprehensive-tab'),
        quickTab: document.getElementById('quick-tab'),
        howItWorksTab: document.getElementById('how-it-works-tab'),
        comprehensivePanel: document.getElementById('comprehensive-panel'),
        quickPanel: document.getElementById('quick-panel'),
        howItWorksPanel: document.getElementById('how-it-works-panel'),
        
        quickGenderRadios: document.querySelectorAll('input[name="quick_gender"]'),
        quickHeirFormContainer: document.getElementById('quick-heir-form-container'),
        quickCalcButtonContainer: document.getElementById('quick-calc-button-container'),
        calculateQuickSharesBtn: document.getElementById('calculate-quick-shares-btn'),
        quickResultsContainer: document.getElementById('quick-results-container'),

        messageModal: document.getElementById('message-modal'),
        modalIcon: document.getElementById('modal-icon'),
        modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'),
        modalCloseBtn: document.getElementById('modal-close-btn'),
    };

    // Tab Switching Logic
    elements.comprehensiveTab.addEventListener('click', () => switchTab('comprehensive'));
    elements.quickTab.addEventListener('click', () => switchTab('quick'));
    elements.howItWorksTab.addEventListener('click', () => switchTab('how-it-works'));

    function switchTab(tabName) {
        const tabs = {
            'comprehensive': { btn: elements.comprehensiveTab, panel: elements.comprehensivePanel },
            'quick': { btn: elements.quickTab, panel: elements.quickPanel },
            'how-it-works': { btn: elements.howItWorksTab, panel: elements.howItWorksPanel }
        };

        for (const key in tabs) {
            const { btn, panel } = tabs[key];
            if (btn && panel) { // Check if elements exist before using them
                if (key === tabName) {
                    btn.classList.add('active');
                    panel.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    panel.classList.add('hidden');
                }
            }
        }
    }


    // Comprehensive Calculator Logic
    function updateProgressBar() {
        const progress = state.currentStep > 0 ? ((state.currentStep - 1) / (state.totalSteps - 1)) * 100 : 0;
        elements.progressBarInner.style.width = `${progress}%`;
        elements.progressPercent.textContent = `${Math.round(progress)}%`;
        const stepTitles = ["", "Deceased's Profile", "Property Inventory", "Heir Identification", "Results"];
        elements.progressText.textContent = `Step ${state.currentStep} of ${state.totalSteps}: ${stepTitles[state.currentStep]}`;

        if(state.currentStep > 0 && state.currentStep <= state.totalSteps) {
            elements.progressContainer.classList.remove('hidden');
        } else {
            elements.progressContainer.classList.add('hidden');
        }
    }

    window.navigateSteps = (direction) => {
        const newStep = state.currentStep + direction;
        if (newStep >= 1 && newStep <= state.totalSteps + 1) {
            goToStep(newStep);
        }
    };

    function goToStep(stepNumber) {
        state.currentStep = stepNumber;
        elements.steps.forEach((step, index) => {
            if (step) {
                if (index + 1 === state.currentStep) {
                    step.classList.remove('hidden');
                } else {
                    step.classList.add('hidden');
                }
            }
        });

        if (state.currentStep === 2) setupPropertyStep();
        if (state.currentStep === 3) setupHeirStep();
        if (state.currentStep === 4) renderResults();
        
        updateProgressBar();
        window.scrollTo(0, 0);
    }
    
    // Step 1: Deceased Profile
    function checkStep1Validity() {
        return !!document.querySelector('input[name="gender"]:checked') &&
               !!document.querySelector('input[name="death_date_period"]:checked') &&
               !!document.querySelector('input[name="pregnant"]:checked');
    }
    
    document.getElementById('step-1').addEventListener('change', () => {
        elements.nextStep1Btn.disabled = !checkStep1Validity();
    });

    elements.nextStep1Btn.addEventListener('click', () => {
        state.deceased.gender = document.querySelector('input[name="gender"]:checked').value;
        state.deceased.diedAfter2005 = document.querySelector('input[name="death_date_period"]:checked').value === 'after';
        state.deceased.childInWomb = document.querySelector('input[name="pregnant"]:checked').value === 'yes';
        if(checkStep1Validity()) goToStep(2);
    });

    // Step 2: Property
    function setupPropertyStep() {
        if (state.properties.length === 0) {
            state.properties.push({ id: Date.now(), value: 500000, source: null });
        }
        renderPropertyForms();
        checkStep2Validity();
    }
    
    function renderPropertyForms() {
        elements.propertyListContainer.innerHTML = state.properties.map((p, index) => {
            const sourceOptions = state.deceased.gender === 'male' ?
                [
                    { value: 'self_acquired', label: 'Purchased with own funds / earnings' },
                    { value: 'gift', label: 'Received as a gift' },
                    { value: 'will', label: 'Inherited through a Will' },
                    { value: 'ancestral', label: 'Inherited from father, paternal grandfather, or paternal great-grandfather' },
                ] :
                [
                    { value: 'general', label: 'Self-acquired (purchased, gift, via Will)' },
                    { value: 'from_parents', label: 'Inherited from father or mother (without a Will)' },
                    { value: 'from_in_laws', label: 'Inherited from husband or father-in-law (without a Will)' }
                ];
            
            return `
            <div class="property-form p-4 border rounded-lg bg-gray-50" data-property-id="${p.id}">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-700">Property #${index + 1}</h4>
                    ${state.properties.length > 1 ? `<button onclick="removeProperty(${p.id})" class="text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button>` : ''}
                </div>
                <div class="space-y-4">
                     <div>
                        <label for="property-value-${p.id}" class="font-medium text-gray-700">Estimated Value (in â‚¹)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="property-value-slider-${p.id}" class="w-full property-value-slider" min="0" max="10000000" step="50000" value="${p.value || 500000}">
                            <input type="number" id="property-value-${p.id}" class="input-field w-40 property-value-input" min="0" value="${p.value || 500000}">
                        </div>
                    </div>
                    <div>
                        <label class="font-medium text-gray-700 flex items-center">How was this property acquired?</label>
                        <div class="mt-2 space-y-2">
                            ${sourceOptions.map(opt => `
                                <div>
                                    <input type="radio" name="property_source_${p.id}" id="source-${opt.value}-${p.id}" value="${opt.value}" class="hidden property-source" ${p.source === opt.value ? 'checked' : ''}>
                                    <label for="source-${opt.value}-${p.id}" class="radio-label">${opt.label}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
        checkStep2Validity();
    }
    
    elements.propertyListContainer.addEventListener('input', (e) => {
        const target = e.target;
        const propertyForm = target.closest('.property-form');
        if (!propertyForm) return;

        const propertyId = Number(propertyForm.dataset.propertyId);
        const property = state.properties.find(p => p.id === propertyId);
        if (!property) return;

        if (target.classList.contains('property-value-input')) {
            property.value = parseFloat(target.value) || 0;
            const slider = propertyForm.querySelector('.property-value-slider');
            if(slider) slider.value = property.value;
        }
        if (target.classList.contains('property-value-slider')) {
            property.value = parseFloat(target.value) || 0;
            const numberInput = propertyForm.querySelector('.property-value-input');
            if(numberInput) numberInput.value = property.value;
        }
        if (target.classList.contains('property-source')) {
            property.source = target.value;
        }
        
        const hasAncestral = state.properties.some(p => p.source === 'ancestral');
        elements.partitionQuestionContainer.classList.toggle('hidden', !hasAncestral);
        
        checkStep2Validity();
    });

    elements.addAnotherPropertyBtn.addEventListener('click', () => {
        state.properties.push({ id: Date.now(), value: 500000, source: null });
        renderPropertyForms();
    });

    window.removeProperty = (id) => {
        state.properties = state.properties.filter(p => p.id !== id);
        renderPropertyForms();
    }

    function checkStep2Validity() {
        const allPropertiesValid = state.properties.every(p => p.value !== null && p.source !== null);
        const hasAncestral = state.properties.some(p => p.source === 'ancestral');
        const partitionAnswered = !!document.querySelector('input[name="partition"]:checked');
        
        const isValid = state.properties.length > 0 && allPropertiesValid && (!hasAncestral || (hasAncestral && partitionAnswered));
        elements.nextStep2Btn.disabled = !isValid;
    }
    
    elements.partitionRadios.forEach(r => r.addEventListener('change', checkStep2Validity));

    elements.nextStep2Btn.addEventListener('click', () => {
        state.deceased.partitionBefore2004 = document.querySelector('input[name="partition"]:checked')?.value === 'yes';
        if (!elements.nextStep2Btn.disabled) {
            goToStep(3);
        }
    });
    
    // Step 3: Heir Identification
    function setupHeirStep() {
        if (state.deceased.gender === 'male') {
            state.heirs = {
                mother: 0,
                widows: 0,
                sons: { living: 0, deceased: 0, branches: [] },
                daughters: { living: 0, deceased: 0, branches: [] },
                father: 0,
                entry2: { sds: 0, sdd: 0, brother: 0, sister: 0 }
            };
        } else {
            state.heirs = {
                husband: 0,
                sons: { living: 0 },
                daughters: { living: 0 }
            };
        }
        renderHeirForm(elements.heirFormContainer, state);
    }
    
    function renderHeirForm(container, stateObj) {
        if (stateObj.deceased.gender === 'male') {
            renderMaleHeirForm(container, stateObj);
        } else {
            renderFemaleHeirForm(container, stateObj);
        }
    }

    function createCounter(label, key, max = 10, stateObj) {
        const keys = key.replace(/\[(\d+)\]/g, '.$1').split('.');
        let value = keys.reduce((o, k) => (o ? o[k] : undefined), stateObj.heirs);
        if (typeof value === 'undefined') {
            value = 0;
        }

        return `
            <div class="p-4 border rounded-lg bg-white flex items-center justify-between">
                <label class="font-semibold text-gray-800">${label}</label>
                <div class="flex items-center space-x-4">
                    <button class="count-btn" data-key="${key}" data-action="decrement">-</button>
                    <span class="count-display">${value}</span>
                    <button class="count-btn" data-key="${key}" data-action="increment" ${value >= max ? 'disabled' : ''}>+</button>
                </div>
            </div>
        `;
    }

    function renderMaleHeirForm(container, stateObj) {
        const { heirs } = stateObj;
        let html = `<div><h3 class="text-xl font-semibold text-center text-gray-700">Class I Heirs</h3>`;
        html += createCounter('Mother', 'mother', 1, stateObj);
        html += createCounter('Widow(s)', 'widows', 10, stateObj);
        html += createCounter('Living Son(s)', 'sons.living', 10, stateObj);
        html += createCounter('Deceased Son(s)', 'sons.deceased', 10, stateObj);
        
        if (heirs.sons.deceased > 0) {
            heirs.sons.branches = heirs.sons.branches.slice(0, heirs.sons.deceased);
            while(heirs.sons.branches.length < heirs.sons.deceased) {
                heirs.sons.branches.push({ widow: 0, sons: 0, daughters: 0 });
            }
            html += `<div class="pl-6 border-l-2 border-blue-200 space-y-2 mt-2">`;
            for(let i=0; i<heirs.sons.deceased; i++) {
                html += `<div class="p-2 border rounded-md bg-blue-50">
                            <h4 class="font-semibold text-blue-800 text-sm mb-2">Branch of Deceased Son #${i+1}</h4>
                            ${createCounter('Widow', `sons.branches[${i}].widow`, 1, stateObj)}
                            ${createCounter('Sons', `sons.branches[${i}].sons`, 10, stateObj)}
                            ${createCounter('Daughters', `sons.branches[${i}].daughters`, 10, stateObj)}
                            </div>`;
            }
            html += `</div>`;
        } else {
            heirs.sons.branches = [];
        }
        
        html += createCounter('Living Daughter(s)', 'daughters.living', 10, stateObj);
        html += createCounter('Deceased Daughter(s)', 'daughters.deceased', 10, stateObj);
        if (heirs.daughters.deceased > 0) {
            heirs.daughters.branches = heirs.daughters.branches.slice(0, heirs.daughters.deceased);
            while(heirs.daughters.branches.length < heirs.daughters.deceased) {
                heirs.daughters.branches.push({ sons: 0, daughters: 0 });
            }
            html += `<div class="pl-6 border-l-2 border-green-200 space-y-2 mt-2">`;
            for(let i=0; i<heirs.daughters.deceased; i++) {
                    html += `<div class="p-2 border rounded-md bg-green-50">
                            <h4 class="font-semibold text-green-800 text-sm mb-2">Branch of Deceased Daughter #${i+1}</h4>
                            ${createCounter('Sons', `daughters.branches[${i}].sons`, 10, stateObj)}
                            ${createCounter('Daughters', `daughters.branches[${i}].daughters`, 10, stateObj)}
                            </div>`;
            }
            html += `</div>`;
        } else {
            heirs.daughters.branches = [];
        }
        html += `</div>`;

        html += `<div class="mt-6"><h3 class="text-xl font-semibold text-center text-gray-700">Class II Heirs</h3>`;
        html += createCounter('Father (Entry I)', 'father', 1, stateObj);
        html += `<div class="mt-4 p-2 border rounded-md bg-gray-100">
                    <h4 class="font-semibold text-gray-800 text-sm mb-2">Entry II Heirs</h4>
                    ${createCounter("Son's daughter's son(s)", 'entry2.sds', 10, stateObj)}
                    ${createCounter("Son's daughter's daughter(s)", 'entry2.sdd', 10, stateObj)}
                    ${createCounter('Brother(s)', 'entry2.brother', 10, stateObj)}
                    ${createCounter('Sister(s)', 'entry2.sister', 10, stateObj)}
                    </div>`;
        html += `</div>`;
        container.innerHTML = html;
    }
    
    function renderFemaleHeirForm(container, stateObj) {
        let html = `<div><h3 class="text-xl font-semibold text-center text-gray-700">Primary Heirs</h3>`;
        html += createCounter('Husband', 'husband', 1, stateObj);
        html += createCounter('Living Son(s)', 'sons.living', 10, stateObj);
        html += createCounter('Living Daughter(s)', 'daughters.living', 10, stateObj);
        html += `</div>`;
        container.innerHTML = html;
    }

    elements.heirFormContainer.addEventListener('click', e => {
        handleCounterClick(e, state);
        renderHeirForm(elements.heirFormContainer, state);
    });

    elements.nextStep3Btn.addEventListener('click', () => {
        calculateShares(state);
        goToStep(4);
    });

    // Quick Calculator Logic
    elements.quickGenderRadios.forEach(radio => radio.addEventListener('change', e => {
        quickState.gender = e.target.value;
        if (quickState.gender === 'male') {
             quickState.heirs = {
                mother: 0, widows: 0,
                sons: { living: 0, deceased: 0, branches: [] },
                daughters: { living: 0, deceased: 0, branches: [] },
                father: 0,
                entry2: { sds: 0, sdd: 0, brother: 0, sister: 0 }
            };
        } else {
             quickState.heirs = {
                husband: 0,
                sons: { living: 0 },
                daughters: { living: 0 }
            };
        }
        quickState.deceased = { gender: quickState.gender };
        renderHeirForm(elements.quickHeirFormContainer, quickState);
        elements.quickHeirFormContainer.classList.remove('hidden');
        elements.quickCalcButtonContainer.classList.remove('hidden');
    }));

    elements.quickHeirFormContainer.addEventListener('click', e => {
        handleCounterClick(e, quickState);
        renderHeirForm(elements.quickHeirFormContainer, quickState);
    });

    function handleCounterClick(event, stateObject) {
        const button = event.target.closest('.count-btn');
        if (!button) return;

        const keyPath = button.dataset.key;
        const action = button.dataset.action;
        
        const keys = keyPath.replace(/\[(\d+)\]/g, '.$1').split('.');
        let current = stateObject.heirs;
        for (let i = 0; i < keys.length - 1; i++) {
            current = current[keys[i]];
        }
        
        let value = current[keys[keys.length - 1]];
        if (action === 'increment') {
            value++;
        } else if (action === 'decrement' && value > 0) {
            value--;
        }
        
        current[keys[keys.length - 1]] = value;
    }
    
    elements.calculateQuickSharesBtn.addEventListener('click', () => {
        calculateShares(quickState);
        renderQuickResults();
    });

    // Calculation Logic (Generalized)
    function calculateShares(stateObj) {
        let finalResults = {};
        if (stateObj.deceased.gender === 'male') {
            finalResults = calculateMaleShares(stateObj);
        } else {
            finalResults = calculateFemaleShares(stateObj);
        }
        stateObj.results = finalResults;
    }
    
    function calculateMaleShares(stateObj) {
        const { heirs, deceased } = stateObj;
        const totalPropertyValue = stateObj.properties ? stateObj.properties.reduce((sum, p) => sum + p.value, 0) : 0;
        let calculationLog = [];
        
        let class1Heirs = [];
        if (heirs.mother > 0) class1Heirs.push({ type: 'Mother', individualNum: 1, shares: 1 });
        for(let i=0; i < heirs.widows; i++) { class1Heirs.push({ type: 'Widow', individualNum: i+1, shares: 1 }); }
        for(let i=0; i < heirs.sons.living; i++) { class1Heirs.push({ type: 'Son', individualNum: i+1, shares: 1 }); }
        for(let i=0; i < heirs.daughters.living; i++) { class1Heirs.push({ type: 'Daughter', individualNum: i+1, shares: 1 }); }

        heirs.sons.branches.forEach((b, i) => {
            const branchHeirsCount = b.widow + b.sons + b.daughters;
            if (branchHeirsCount > 0) {
                class1Heirs.push({ type: `Branch of Deceased Son #${i+1}`, shares: 1, branch: b });
            }
        });
        heirs.daughters.branches.forEach((b, i) => {
            const branchHeirsCount = b.sons + b.daughters;
            if (branchHeirsCount > 0) {
                class1Heirs.push({ type: `Branch of Deceased Daughter #${i+1}`, shares: 1, branch: b });
            }
        });

        if (deceased && deceased.childInWomb) {
            class1Heirs.push({ type: 'Unborn Child', individualNum: 1, shares: 1, provisional: true });
        }
        
        const hasClass1Heirs = class1Heirs.length > 0;

        if (hasClass1Heirs) {
            const totalShares = class1Heirs.reduce((sum, h) => sum + h.shares, 0);
            
            class1Heirs.forEach(heir => {
                if (!heir.branch) {
                    const share = new Fraction(heir.shares, totalShares);
                    calculationLog.push({
                        name: `${heir.type} ${heir.individualNum > 1 ? heir.individualNum : ''}`.trim(),
                        shareFraction: share,
                        value: share.valueOf() * totalPropertyValue,
                        reason: `Receives one share as a Class I heir under Sec. 10 of the HSA.`,
                        provisional: heir.provisional || false
                    });
                } else { // Handle branches
                    const branchShare = new Fraction(1, totalShares);
                    let branchHeirsList = [];
                    for(let i=0; i<heir.branch.widow; i++) branchHeirsList.push({type: 'Widow', count: 1});
                    for(let i=0; i<heir.branch.sons; i++) branchHeirsList.push({type: 'Son', count: 1});
                    for(let i=0; i<heir.branch.daughters; i++) branchHeirsList.push({type: 'Daughter', count: 1});
                    
                    const totalBranchSubshares = branchHeirsList.length;
                    
                    branchHeirsList.forEach((bh, i) => {
                        const subShare = branchShare.div(totalBranchSubshares);
                         calculationLog.push({
                            name: `${bh.type} #${i+1} in ${heir.type}`,
                            shareFraction: subShare,
                            value: subShare.valueOf() * totalPropertyValue,
                            reason: `Inherits a portion of the branch's share per stirpes under Sec. 10, Rule 4 of the HSA.`
                        });
                    });
                }
            });
            calculationLog.push({name: 'Father', shareFraction: new Fraction(0), value: 0, reason: 'Does not inherit as Class I heirs take priority under Sec. 8 of the HSA.'});
            calculationLog.push({name: 'Class II Heirs', shareFraction: new Fraction(0), value: 0, reason: 'Do not inherit as Class I heirs take priority.'});

        } else if (heirs.father > 0) {
            calculationLog.push({ name: 'Father', shareFraction: new Fraction(1), value: totalPropertyValue, reason: 'Inherits the entire property as the sole Class II, Entry I heir under Sec. 11 of the HSA.'});
            calculationLog.push({name: 'Class II, Entry II Heirs', shareFraction: new Fraction(0), value: 0, reason: 'Do not inherit as Entry I heirs take priority.'});
        } else {
            let entry2Heirs = [];
            for(let i=0; i<heirs.entry2.sds; i++) entry2Heirs.push({type: "Son's daughter's son", count: 1});
            for(let i=0; i<heirs.entry2.sdd; i++) entry2Heirs.push({type: "Son's daughter's daughter", count: 1});
            for(let i=0; i<heirs.entry2.brother; i++) entry2Heirs.push({type: 'Brother', count: 1});
            for(let i=0; i<heirs.entry2.sister; i++) entry2Heirs.push({type: 'Sister', count: 1});
            
            const totalEntry2Shares = entry2Heirs.length;
            if (totalEntry2Shares > 0) {
                entry2Heirs.forEach((h, i) => {
                    const share = new Fraction(1, totalEntry2Shares);
                    calculationLog.push({ name: `${h.type} #${i+1}`, shareFraction: share, value: share.valueOf() * totalPropertyValue, reason: `Inherits as a Class II, Entry II heir under Sec. 11 of the HSA. All heirs in this entry share equally.` });
                });
            } else {
                 calculationLog.push({ name: 'No Heirs Found', shareFraction: new Fraction(0), value: 0, reason: 'No Class I or specified Class II heirs were found. Property may go to other relatives (Agnates/Cognates). Consult a lawyer.'});
            }
        }
        
        return { all: { heirs: calculationLog } };
    }

    function calculateFemaleShares(stateObj) {
        const { heirs, deceased, properties } = stateObj;
        const results = {};
        const props = properties && properties.length > 0 ? properties : [{value: 0, source: 'general'}];

        props.forEach((prop, index) => {
            const calculationLog = [];
            const hasIssue = (heirs.sons.living > 0 || heirs.daughters.living > 0) || (deceased && deceased.childInWomb);

            if (prop.source === 'from_parents' && !hasIssue) {
                 calculationLog.push({ name: "Heirs of Father", shareFraction: new Fraction(1), value: prop.value, reason: "Property inherited from parents reverts to father's heirs if the female dies without issue, per Sec. 15(2)(a) of the HSA."});
            } else if (prop.source === 'from_in_laws' && !hasIssue) {
                 calculationLog.push({ name: "Heirs of Husband", shareFraction: new Fraction(1), value: prop.value, reason: "Property inherited from husband/father-in-law reverts to husband's heirs if the female dies without issue, per Sec. 15(2)(b) of the HSA."});
            } else {
                 let primaryHeirs = [];
                 if (heirs.husband > 0) primaryHeirs.push({type: 'Husband', count: 1});
                 for(let i=0; i<heirs.sons.living; i++) primaryHeirs.push({type: 'Son', count: 1, individualNum: i+1});
                 for(let i=0; i<heirs.daughters.living; i++) primaryHeirs.push({type: 'Daughter', count: 1, individualNum: i+1});
                 if (deceased && deceased.childInWomb) primaryHeirs.push({type: 'Unborn Child', count: 1, provisional: true});
                 
                 const totalShares = primaryHeirs.length;

                 if (totalShares > 0) {
                     primaryHeirs.forEach(h => {
                         const share = new Fraction(1, totalShares);
                         calculationLog.push({
                             name: `${h.type} ${h.individualNum ? h.individualNum : ''}`.trim(),
                             shareFraction: share,
                             value: share.valueOf() * (prop.value || 0),
                             reason: `Inherits as a primary heir under the general rule of Sec. 15(1)(a) of the HSA.`,
                             provisional: h.provisional
                         });
                     });
                 } else {
                     calculationLog.push({ name: "Heirs of Husband", shareFraction: new Fraction(1), value: prop.value || 0, reason: "No primary heirs found. As per Sec. 15(1)(b), property devolves to the husband's heirs."});
                 }
            }
            results[index] = { heirs: calculationLog };
        });
        return results;
    }

    
    // Comprehensive Results Rendering
    function renderResults() {
        renderResultsPanel(elements.resultsContainer, state, true);
    }
    
    // Quick Results Rendering
    function renderQuickResults() {
        renderResultsPanel(elements.quickResultsContainer, quickState, false);
    }

    function renderResultsPanel(container, stateObj, showValue) {
        container.innerHTML = '';
        const isMale = stateObj.deceased.gender === 'male';

        const renderSection = (title, resultData, index) => {
            const section = document.createElement('div');
            
            const inheritingHeirs = resultData.heirs.filter(h => h.shareFraction.n > 0);

            let chartHtml = showValue ? `<p class="text-center text-gray-500 my-4">No heirs with a share to display.</p>` : '';
            if(showValue && inheritingHeirs.length > 0) {
                chartHtml = `<div class="chart-container my-6">
                                <canvas id="chart-${container.id}-${index}"></canvas>
                             </div>`;
            }

            let tableHtml = `<p class="text-center text-gray-500 my-4">No distribution data available.</p>`;
            if(resultData.heirs.length > 0) {
                tableHtml = `
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 font-semibold text-sm text-left">Heir</th>
                                <th class="p-3 font-semibold text-sm text-center">Share (%)</th>
                                ${showValue ? `<th class="p-3 font-semibold text-sm text-right">Value (â‚¹)</th>` : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${resultData.heirs.map(h => `
                            <tr class="border-b">
                                <td class="p-3">
                                    <p class="font-semibold capitalize">${h.name} ${h.provisional ? '<span class="text-xs text-red-500">(Provisional)</span>' : ''}</p>
                                    <p class="text-xs text-gray-600 italic mt-1">${h.reason}</p>
                                </td>
                                <td class="p-3 font-mono text-center">${h.shareFraction.n > 0 ? (h.shareFraction.valueOf() * 100).toFixed(2) + '%' : '0.00%'}</td>
                                ${showValue ? `<td class="p-3 text-right font-medium">â‚¹${h.value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>` : ''}
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            }
            
            section.innerHTML = `
                <div class="mb-8 border-b pb-8">
                    <h3 class="text-xl font-bold text-gray-800 text-center mb-4">${title}</h3>
                    ${chartHtml}
                    ${tableHtml}
                </div>
            `;
            container.appendChild(section);

            if (showValue && inheritingHeirs.length > 0) {
                 const chartId = `chart-${container.id}-${index}`;
                 section.querySelector('canvas').id = chartId;
                 const ctx = document.getElementById(chartId).getContext('2d');
                 new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: inheritingHeirs.map(h => h.name), datasets: [{ data: inheritingHeirs.map(h => h.shareFraction.valueOf() * 100), backgroundColor: ['#4A90E2', '#50E3C2', '#F5A623', '#BD10E0', '#7ED321', '#417505', '#9013FE', '#D0021B', '#F8E71C', '#B8E986'], borderColor: '#FDFBF7', borderWidth: 3 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed.toFixed(2)}%` } } } }
                });
            }
        };

        if (isMale || !showValue) {
            renderSection('Overall Distribution', stateObj.results.all, 'all');
        } else {
            Object.keys(stateObj.results).forEach(propIndex => {
                const title = `Distribution of Property #${parseInt(propIndex) + 1}`;
                renderSection(title, stateObj.results[propIndex], propIndex);
            });
        }
    }
    
    window.restart = () => {
        Object.assign(state, { currentStep: 1, deceased: {}, properties: [], heirs: {}, results: {} });
        elements.app.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
        goToStep(1);
    };

    goToStep(1);
});
</script>
</body>
</html>
